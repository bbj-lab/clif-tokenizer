# use this file with:
# export TMPDIR="/scratch/$(whoami)/cache"
# export APPTAINER_TMPDIR="/scratch/$(whoami)/cache"
# export APPTAINER_CACHEDIR="/scratch/$(whoami)/cache"
# apptainer build env.sif env.def
# apptainer run --nv env.sif

# troubleshoot with:
# apptainer exec env.sif ls

Bootstrap: docker
From: python:3.12.11-bullseye

%files
    requirements-docker.txt /src/
    pyproject.toml /src/
    fms_ehrs /src/

%post
    cd /src
    python -m venv /opt/venv
    /opt/venv/bin/pip install --no-cache-dir torch --extra-index-url https://download.pytorch.org/whl/cu128
    /opt/venv/bin/pip install --no-build-isolation -r requirements-docker.txt
    /opt/venv/bin/pip install --no-deps .

%environment
    export PATH=/opt/venv/bin:$PATH
